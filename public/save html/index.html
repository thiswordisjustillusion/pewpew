<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>testdb</title>
    <link rel="stylesheet" href="../style.css" media="all">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>

</head>

<body>
    <!-- Шапка -->
    <nav>
        <ul class="menu-main">
            <li><a href="/">Смотреть</a></li>
            <li><a href="/recomended1">Рекомендации1</a></li>
            <li><a href="/recomended2">Рекомендации2</a></li>
            <li>
                <input type="text" id="IDsearch" placeholder="Поиск"/>
                <button id="btn-search">+</button>
            </li>
        </ul>
    </nav>

    <!-- Контент -->
    <div class="content">

        <!-- Фильтрация + сортировка -->
            <ul class="filter-sort">
                <li class="genres">Жанры
                    <ul class="subgenres">
                        <li><input type="checkbox" class="boxGenre" id="g0" value=0 />боевик</li>
                        <li><input type="checkbox" class="boxGenre" id="g1" value=1 />комедия</li>
                        <li><input type="checkbox" class="boxGenre" id="g2" value=2 />драма</li>
                        <li><input type="checkbox" class="boxGenre" id="g3" value=3 />фантастика</li>
                        <li><input type="checkbox" class="boxGenre" id="g4" value=4 />ужасы</li>
                        <li><input type="checkbox" class="boxGenre" id="g5" value=5 />исторический</li>
                        <li><input type="checkbox" class="boxGenre" id="g6" value=6 />детектив</li>
                        <li><input type="checkbox" class="boxGenre" id="g7" value=7 />мелодрама</li>
                        <li><input type="checkbox" class="boxGenre" id="g8" value=8 />триллер</li>
                        <li><input type="checkbox" class="boxGenre" id="g9" value=9 />вестерн</li>
                    </ul>
                </li>
                <li class="years">Год
                    <ul class="subyears">
                        <li><input type="text" class="boxYear" id="year1" placeholder="год1"/></li>
                        <li><input type="text" class="boxYear" id="year2" placeholder="год2"/></li>
                    </ul>
                </li>
                <li class="countries">Страны
                    <ul class="subcountries">
                        <li><input type="checkbox" class="boxCountry" value="Great Britain" />Великобритания</li>
                        <li><input type="checkbox" class="boxCountry" value="Italy" />Италия</li>
                        <li><input type="checkbox" class="boxCountry" value="China" />Китай</li>
                        <li><input type="checkbox" class="boxCountry" value="Russia" />Россия</li>
                        <li><input type="checkbox" class="boxCountry" value="USA" />США</li>
                        <li><input type="checkbox" class="boxCountry" value="France" />Франция</li>
                    </ul>
                </li>
                <li class="sort">Сортировка
                    <ul class="subsort">
                        <li><input type="radio" class="boxSort" name="boxSort" value="rating" checked/>Рейтинг</li>
                        <li><input type="radio" class="boxSort" name="boxSort" value="year" />Дата выхода</li>
                        <li><input type="radio" class="boxSort" name="boxSort" value="views" />Просмотры</li>
                    </ul>
                </li>
                <button id="btn-genre"> Применить настройки </button>
            </ul>
            

        <!-- Фильмы -->
        <div class="films"></div>
        <div id="films-more"></div>
    </div>
    <script>
        let allTitleMovie = [];
        let countryGenre = [];
        let getMovies = [];
        let allViewFilms = [];
    //не более 3х выбранных жанров
        $('.boxGenre:checkbox').click(function(){
            if ($('.boxGenre:checkbox:checked').length > 3){
                return false;
            }
        })
        
//отправка формы и получение готового списка бла бла бла хочу спать
    $("#btn-genre").click(function () {
        //жанры
        let checkedGenre = [];
        $('.boxGenre:checkbox:checked').each(function(){
            checkedGenre.push($(this).val())
        });
        for (i=0; i < checkedGenre.length; i++) {
            checkedGenre[i] = Number(checkedGenre[i])
        }
        //страны
        let checkedCountry = [];
        $('.boxCountry:checkbox:checked').each(function(){
            checkedCountry.push($(this).val())
        });
        //года
        let checkedYear = [];
        $('.boxYear:text').val(function(){
            checkedYear.push($(this).val())
        });
        for (i=0; i < checkedYear.length; i++) {
            checkedYear[i] = Number(checkedYear[i])
        }
        //сортировка
        let checkedSort = "";
        checkedSort = $('.boxSort:radio:checked').val();

        console.log('Выбрано:',checkedGenre, checkedCountry, checkedYear, checkedSort)
        $.ajax({
                url: "/movies",
                contentType: "application/json",
                method: "POST",
                data: JSON.stringify({
                    genreM: checkedGenre,
                    yearM: checkedYear,
                    sortM: checkedSort
                }),
                success: function (movies) {
                    let flag = 0;
                    let j = 0;
                    let countryCheck = [];

                    //отборка N выбранных стран (в countryCheck)
                    if (checkedCountry.length > 0) {
                        $.each(movies, function (index, movie) {
                            flag = 0;
                            for (i = 0; i < checkedCountry.length; i++) {
                                if (movie.country == checkedCountry[i]) {
                                    flag = 1;
                                    countryCheck[j] = true;
                                    break;
                                }
                            }
                            j++;
                        })
                    //запись выбранных стран в массив counryGenre
                    j=0;
                    console.log('countryCheck',countryCheck)
                    for (i=0; i<movies.length; i++) {
                        if (countryCheck[i]) {
                            countryGenre[j] = movies[i];
                            j++;
                        }
                    }
                    console.log('movies', movies)
                } else countryGenre = movies;
                console.log('countryGenre',countryGenre);
                //получение названий фильмов в массив allTitleMovie
                i = 0;
                $.each(countryGenre, function (index, movie) {
                    allTitleMovie[i] = movie.title;
                    i++;
                })
                console.log('Title отфильтрованных фильмов',allTitleMovie)
                $('.films').empty();
                GetFilterMovie ();
                }
            })
        });

    function GetFilterMovie() {
        let dontViewFilms = allTitleMovie;
        let flag = 0;
        let carts = "";
        let viewFilms = 0;
        while ((dontViewFilms.length > 0) && (viewFilms < 3)) {
            flag = 0;
            $.each(countryGenre, function (index, movie) {
                if (dontViewFilms[0] == movie.title) {
                    carts += cart(movie);
                    viewFilms++;
                    flag = 1;
                }
            })
            if (flag == 1) dontViewFilms.splice(0,1);
        }
        console.log('viewFilms', viewFilms)  
        console.log('dontViewFilms', dontViewFilms)
        
        $('.films').append(carts);
        $('#films-more').empty();
        $('#films-more').append('<button onclick="GetFilterMovie()">Показать ещё</button>');
    }


    function GetMovies1() {
        $.ajax({
            url: "/movies",
            type: "GET",
            contentType: "application/json",
            success: function (movies) {
                let carts = "";
                let viewFilms = 0;
                $.each(movies, function (index, movie) {
                    //записываем названия всех выводимых фильмов в allViewFilms
                    allViewFilms[index] = movie.title;
                });
                getMovies = movies;
                GetMovies2();
            }
        });
    }

    // Получение всех фильмов
    function GetMovies2() {
        let carts = "";
        let viewFilms = 0;
        let dontViewFilms = allViewFilms;
        while ((dontViewFilms.length > 0) && (viewFilms < 5)) {
            flag = 0;
            $.each(getMovies, function (index, movie) {
                if (dontViewFilms[0] == movie.title) {
                    // добавляем полученные элементы
                    carts += cart(movie);
                    viewFilms++;
                    flag = 1;
                }
            })
            if (flag == 1) dontViewFilms.splice(0, 1);
        }
        console.log('viewFilms', viewFilms)
        console.log('dontViewFilms', dontViewFilms)
        $(".films").append(carts);
        $('#films-more').empty();
        $('#films-more').append('<button onclick="GetMovies2()">Показать ещё</button>');   
    }

    /////////////////поиск
    $("#btn-search").click(function () {
        let letSearch = [];
        let carts = "";
        $('#IDsearch:text').val(function(){
            letSearch.push($(this).val())
        });
        $.ajax({
                url: "/search",
                contentType: "application/json",
                method: "POST",
                data: JSON.stringify({
                    searchM: letSearch
                }),
                success: function (sumSearch) {
                    $.each(sumSearch, function (index, search) {
                        console.log(search);
                        carts += cart(search);
                    })    
                $(".films").empty();
                $(".films").append(carts);
                }
            })
    });

    // вывод фильмов
    let cart = function (movie) {
        return "<div class='cart' id='" + movie._id + "'>" +
            "<a class='title' href='/movie/" + movie.title + "'>" + movie.title + "</a></br>" +
            "<img src='/img/" + movie.img + "' /></br>" +
            movie.genre + "</br> Рейтинг: " + movie.rating +
            "</br> Режиссёр: " + movie.actors +
            "</div>";
    }
    GetMovies1()
    </script>
</body>

</html>